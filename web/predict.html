<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Predict Game Outcome</title>
    <link rel="stylesheet" href="/static/app.css?v=2" />
  </head>
  <body>
  <div class="topbar">
    <div class="inner">
      <a class="brand" href="/" onclick="if (location.protocol==='file:'){location.href='index.html'; return false;}">NBA Search</a>
      <div class="nav">
        <a href="/">Search</a>
        <a href="/predict-ui">Predict</a>
      </div>
    </div>
  </div>


  <div class="page predict-page">
    <div class="wrap">
    <div class="predict-hero">
      <h1 class="fade-in">Predict Game Outcome</h1>
      <p class="sub">Choose the <b>home</b> and <b>away</b> teams. We estimate win probabilities using recent form (last year), rest and an arena/home baseline for a realistic split.</p>
    </div>


    <form id="formPredict" class="card predict-card" autocomplete="off" novalidate>
      <div class="predict-row">
        <!-- Home field -->
        <div class="rel predict-field field">
          <label for="home" class="label">Home team</label>
          <div class="input-wrap">
            <span class="prefix" aria-hidden>🏠</span>
              <input id="home" class="input" type="text" placeholder="e.g. Lakers" aria-autocomplete="list" />
            <button type="button" class="icon-btn clear" id="clearHome" title="Clear" aria-label="Clear home team">✕</button>
          </div>
          <div class="hint">Type a team name or city</div>
          <div id="sugg-home" class="suggest" style="display:none"></div>
        </div>

        <!-- Swap button on small screens moves below -->
        <div class="swap-col">
          <button type="button" class="icon-btn swap-btn" id="swapBtn" title="Swap home/away" aria-label="Swap home and away">⇅</button>
        </div>

        <!-- Away field -->
        <div class="rel predict-field field">
          <label for="away" class="label">Away team</label>
          <div class="input-wrap">
            <span class="prefix" aria-hidden>🛫</span>
              <input id="away" class="input" type="text" placeholder="e.g. Celtics" aria-autocomplete="list" />
            <button type="button" class="icon-btn clear" id="clearAway" title="Clear" aria-label="Clear away team">✕</button>
          </div>
          <div class="hint">Type a team name or city</div>
          <div id="sugg-away" class="suggest" style="display:none"></div>
        </div>
      </div>


      <div id="loading" class="progress" style="display:none"><div class="bar"></div></div>


      <div class="predict-actions">
        <button id="btn" class="btn" type="submit">
          <span class="btn-inner"><span class="btn-spinner" aria-hidden></span><span>Predict</span></span>
        </button>
      </div>


      <p class="error" id="err" role="alert"></p>


      <div class="result" id="res" style="display:grid; gap:10px"></div>
    </form>
    <footer style="margin: 28px 0; color: var(--muted); font-size: 12px;">Minimal UI. Results powered by the local FastAPI service.</footer>
    </div>
  </div>

    <script>
      const home = document.getElementById('home');
      const away = document.getElementById('away');
      const sh = document.getElementById('sugg-home');
      const sa = document.getElementById('sugg-away');
      const form = document.getElementById('formPredict');
      const btn = document.getElementById('btn');
      const swapBtn = document.getElementById('swapBtn');
      const clearHome = document.getElementById('clearHome');
      const clearAway = document.getElementById('clearAway');
      const err = document.getElementById('err');
      const res = document.getElementById('res');
      const loading = document.getElementById('loading');

      async function predict() {
        err.textContent = '';
        res.innerHTML = '';
        const h = (home.value || '').trim();
        const a = (away.value || '').trim();
        if (!h || !a) { err.textContent = 'Please enter both teams.'; return; }
        btn.disabled = true; btn.classList.add('loading');
        if (loading) loading.style.display = 'block';
        try {
          const qs = new URLSearchParams({ home: h, away: a });
          const r = await fetch('/predict?' + qs.toString(), { headers: { 'accept': 'application/json' } });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const data = await r.json();
          if (data.error) { err.textContent = data.error; return; }
          const homeName = data.home || 'Home';
          const awayName = data.away || 'Away';
          const pH = Math.round((data.p_home_win ?? 0) * 1000) / 10;
          const pA = Math.round((data.p_away_win ?? 0) * 1000) / 10;
          const card = document.createElement('div'); card.className = 'card result-card'; card.style.display='grid'; card.style.gap='10px';
          const win = document.createElement('div'); win.className='winner-line'; win.textContent = (data.winner === 'home' ? `Winner: ${homeName}` : `Winner: ${awayName}`);
          const meters = document.createElement('div'); meters.className='meter-group';
          const mkMeter = (label, pct) => {
            const row = document.createElement('div'); row.className='meter';
            const lab = document.createElement('div'); lab.className='meter-label'; lab.textContent = label;
            const bar = document.createElement('div'); bar.className='bar';
            const fill = document.createElement('span'); fill.className='fill'; fill.style.width = (Math.max(0, Math.min(100, pct))).toFixed(1) + '%';
            bar.appendChild(fill);
            const pctEl = document.createElement('div'); pctEl.className='pct'; pctEl.textContent = pct.toFixed(1) + '%';
            row.appendChild(lab); row.appendChild(bar); row.appendChild(pctEl);
            return row;
          };
          meters.appendChild(mkMeter(homeName, pH));
          meters.appendChild(mkMeter(awayName, pA));
          card.appendChild(win);
          card.appendChild(meters);
          res.appendChild(card);
        } catch (e) {
          err.textContent = (e && e.message) ? e.message : String(e);
        } finally {
          btn.disabled = false; btn.classList.remove('loading');
          if (loading) loading.style.display = 'none';
        }
      }

      // Suggest support
      function renderSuggest(container, input, items) {
        if (!items || items.length === 0) { container.style.display='none'; container.innerHTML=''; return; }
        container.innerHTML = '';
        const uniq = [];
        const seen = new Set();
        (items || []).forEach(it => {
          const key = String(it._id || it.id || it.team_id || it._title || '');
          if (!key || seen.has(key)) return; seen.add(key); uniq.push(it);
        });
        uniq.slice(0, 10).forEach((it, idx) => {
          const div = document.createElement('div');
          div.className = 's-item' + (idx === 0 ? ' active' : '');
          const badge = document.createElement('div'); badge.className='s-entity'; badge.textContent='team';
          const box = document.createElement('div');
          const t = document.createElement('div'); t.className='s-title'; t.textContent = it._title || '';
          const s = document.createElement('div'); s.className='s-sub'; s.textContent = it._subtitle || '';
          box.appendChild(t); if (s.textContent) box.appendChild(s);
          div.appendChild(badge); div.appendChild(box);
          div.addEventListener('mousedown', (ev) => { ev.preventDefault(); input.value = it._title || it._id || ''; container.style.display='none'; });
          container.appendChild(div);
        });
        container.style.display='block';
      }
      async function fetchTeamSuggest(text) {
        const res = await fetch(`/suggest?q=${encodeURIComponent(text)}&entity=team&limit=15`, { headers: { 'accept':'application/json' } });
        if (!res.ok) return [];
        const data = await res.json();
        const items = (data.items || []).filter(it => (it._entity||'') === 'team');
        return items;
      }
      function wireSuggest(input, container) {
        let timer = null;
        input.addEventListener('input', () => {
          const text = (input.value || '').trim();
          if (timer) clearTimeout(timer);
          if (!text) { container.style.display='none'; return; }
          timer = setTimeout(async () => {
            try { const items = await fetchTeamSuggest(text); renderSuggest(container, input, items); } catch {}
          }, 160);
        });
        input.addEventListener('keydown', (ev) => {
          if (container.style.display === 'none') return;
          const items = Array.from(container.querySelectorAll('.s-item'));
          if (!items.length) return;
          const idx = items.findIndex(n => n.classList.contains('active'));
          if (ev.key === 'ArrowDown' || ev.key === 'ArrowUp') {
            ev.preventDefault();
            let ni = idx + (ev.key === 'ArrowDown' ? 1 : -1);
            if (ni < 0) ni = items.length-1; if (ni >= items.length) ni = 0;
            items.forEach(n => n.classList.remove('active')); items[ni].classList.add('active');
            items[ni].scrollIntoView({ block:'nearest' });
          } else if (ev.key === 'Enter') {
            const active = items[idx >= 0 ? idx : 0]; if (active) active.dispatchEvent(new MouseEvent('mousedown'));
          } else if (ev.key === 'Escape') {
            container.style.display='none';
          }
        });
        input.addEventListener('blur', () => setTimeout(() => container.style.display='none', 150));
      }

      // Events
      form.addEventListener('submit', (ev) => { ev.preventDefault(); predict(); });
      btn.addEventListener('click', (ev) => { ev.preventDefault(); predict(); });
      if (swapBtn) swapBtn.addEventListener('click', () => { const t = home.value; home.value = away.value; away.value = t; });
      if (clearHome) clearHome.addEventListener('click', () => { home.value=''; err.textContent=''; res.innerHTML=''; });
      if (clearAway) clearAway.addEventListener('click', () => { away.value=''; err.textContent=''; res.innerHTML=''; });

      // Wire suggests
      wireSuggest(home, sh);
      wireSuggest(away, sa);

      // Pre-fill and autorun
      try {
        const u = new URL(location.href);
        const hp = (u.searchParams.get('home') || '').trim();
        const ap = (u.searchParams.get('away') || '').trim();
        if (hp) home.value = hp;
        if (ap) away.value = ap;
        if (hp && ap) predict();
      } catch {}
    </script>
  </body>
  </html>





