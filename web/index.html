<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NBA Search</title>
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body>
    <div class="topbar">
      <div class="inner">
        <a class="brand" href="/" onclick="if (location.protocol==='file:'){location.href='index.html'; return false;}">NBA Search</a>
        <div class="nav">
          <a href="/">Search</a>
          <a href="/predict-ui">Predict</a>
        </div>
      </div>
    </div>
    <div class="wrap">
      <h1 class="fade-in">Search (players / teams / games)</h1>
      <form id="f" class="search-box" autocomplete="off">
        <input id="q" class="input" type="text" placeholder="e.g. Michael Jordan, Lakers 2010, 2016-06-19" autocomplete="off" aria-autocomplete="list" />
        <button id="btn" class="btn" type="submit">Search</button>
        <div id="sugg" class="suggest" style="display:none"></div>
      </form>
      <div class="meta" id="meta"></div>
      <div class="error" id="err"></div>

      <!-- Home sections (hidden when searching) -->
      <div id="home" class="home">
        <div class="section">
          <div class="title">Most Popular Players</div>
          <div class="chips" id="chips-players">
            <div class="chip">LeBron James</div>
            <div class="chip">Stephen Curry</div>
            <div class="chip">Kevin Durant</div>
            <div class="chip">Nikola Jokic</div>
            <div class="chip">Luka Doncic</div>
            <div class="chip">Victor Wembanyama</div>
            <div class="chip">Giannis Antetokounmpo</div>
            <div class="chip">Jayson Tatum</div>
            <div class="chip">Kobe Bryant</div>
            <div class="chip">Dirk Nowitzki</div>
            <div class="chip">Allen Iverson</div>
          </div>
          <div class="list" style="margin-top:12px">
            <div class="title">Head-to-Head Builder</div>
            <div class="row" style="display:grid; grid-template-columns: 1fr 40px 1fr auto; gap:8px; align-items:end;">
              <div class="rel">
                <label class="sub" for="h2h-home" style="display:block;margin:0 0 4px;">Home team <span class="badge-mini" aria-hidden>H</span></label>
                <input id="h2h-home" class="input" type="text" placeholder="e.g. Lakers" autocomplete="off" aria-autocomplete="list" />
                <div id="sugg-h2h-home" class="suggest" style="display:none"></div>
              </div>
              <div class="swap-col">
                <button type="button" class="icon-btn swap-btn" id="swapH2HBtn" title="Swap home/away" aria-label="Swap home and away"></button>
              </div>
              <div class="rel">
                <label class="sub" for="h2h-away" style="display:block;margin:0 0 4px;">Away team <span class="badge-mini" aria-hidden>A</span></label>
                <input id="h2h-away" class="input" type="text" placeholder="e.g. Celtics" autocomplete="off" aria-autocomplete="list" />
                <div id="sugg-h2h-away" class="suggest" style="display:none"></div>
              </div>
              <button id="btnH2H" class="btn">Go</button>
            </div>
          </div>
          <div class="list" id="quick-links" style="margin-top:12px">
            <div class="title">Teams</div>
            <div class="chips">
              <a class="chip" href="/?q=Los%20Angeles%20Lakers" data-team="Los Angeles Lakers">Lakers</a>
              <a class="chip" href="/?q=Boston%20Celtics" data-team="Boston Celtics">Celtics</a>
              <a class="chip" href="/?q=Golden%20State%20Warriors" data-team="Golden State Warriors">Warriors</a>
              <a class="chip" href="/?q=Phoenix%20Suns" data-team="Phoenix Suns">Suns</a>
              <a class="chip" href="/?q=Milwaukee%20Bucks" data-team="Milwaukee Bucks">Bucks</a>
              <a class="chip" href="/?q=Philadelphia%2076ers" data-team="Philadelphia 76ers">76ers</a>
              <a class="chip" href="/?q=New%20York%20Knicks" data-team="New York Knicks">Knicks</a>
              <a class="chip" href="/?q=Miami%20Heat" data-team="Miami Heat">Heat</a>
              <a class="chip" href="/?q=Dallas%20Mavericks" data-team="Dallas Mavericks">Mavericks</a>
              <a class="chip" href="/?q=Denver%20Nuggets" data-team="Denver Nuggets">Nuggets</a>
              <a class="chip" href="/?q=Los%20Angeles%20Clippers" data-team="Los Angeles Clippers">Clippers</a>
              <a class="chip" href="/?q=Chicago%20Bulls" data-team="Chicago Bulls">Bulls</a>
            </div>
          </div>
          <div class="list" id="predict-inline" style="margin-top:12px">
            <div class="title">Prediction</div>
            <div class="inline-predict">
              <div class="inline-predict-row">
                <div class="rel">
                  <label class="sub" for="pred-home" style="display:block;margin:0 0 4px;">Home team <span class="badge-mini" aria-hidden>H</span></label>
                  <input id="pred-home" class="input" type="text" placeholder="e.g. Lakers" autocomplete="off" aria-autocomplete="list" />
                  <div id="sugg-pred-home" class="suggest" style="display:none"></div>
                </div>
                <div class="swap-col">
                  <button type="button" class="icon-btn swap-btn" id="swapPredBtn" title="Swap home/away" aria-label="Swap home and away"></button>
                </div>
                <div class="rel">
                  <label class="sub" for="pred-away" style="display:block;margin:0 0 4px;">Away team <span class="badge-mini" aria-hidden>A</span></label>
                  <input id="pred-away" class="input" type="text" placeholder="e.g. Celtics" autocomplete="off" aria-autocomplete="list" />
                  <div id="sugg-pred-away" class="suggest" style="display:none"></div>
                </div>
              </div>
            </div>
            <div class="inline-predict-actions">
              <button id="btnPred" class="btn">Start Prediction</button>
            </div>
          </div>
        </div>
        <div class="section">
          <div class="title">NBA Standings</div>
          <div class="standings" id="standings">
            <div class="conf" id="std-east"><div class="title">East</div>
            <div class="head"><div class="col-name">Team</div><div class="col-wl">W-L</div><div class="col-gb">GB</div><div class="col-streak">Streak</div></div></div>
            <div class="conf" id="std-west"><div class="title">West</div>
            <div class="head"><div class="col-name">Team</div><div class="col-wl">W-L</div><div class="col-gb">GB</div><div class="col-streak">Streak</div></div></div>
          </div>
          <div style="margin-top:12px; display:flex; gap:10px;">
            <a class="btn secondary" href="/?q=2024-06-19">Explore a game date</a>
          </div>
        </div>
      </div>

      <div class="results" id="results"></div>
      <div id="detail" class="card" style="display:none; position: fixed; right: 20px; bottom: 20px; max-width: 420px; z-index: 10;"></div>
      <footer style="margin: 28px 0; color: var(--muted); font-size: 12px;">
        Minimal UI. Results powered by the local FastAPI service.
      </footer>
    </div>
    <script src="/static/app.js"></script>
    <script>
      const f = document.getElementById('f');
      const q = document.getElementById('q');
      const btn = document.getElementById('btn');
      const meta = document.getElementById('meta');
      const err = document.getElementById('err');
      const results = document.getElementById('results');
      const sugg = document.getElementById('sugg');
      const home = document.getElementById('home');
      let lastGoodQuery = '';
      let lastGoodItems = [];
      let activeSuggestReq = 0;

      function openEntity(it) {
        if (!it || !it._entity || !it._id) return;
        let path = '/';
        if (it._entity === 'player') path = `/player/${encodeURIComponent(it._id)}`;
        else if (it._entity === 'team') path = `/team/${encodeURIComponent(it._id)}`;
        else if (it._entity === 'game') path = `/game/${encodeURIComponent(it._id)}`;
        else if (it._entity === 'matchup') {
          const parts = String(it._id).split('-');
          if (parts.length === 2) path = `/matchup/${encodeURIComponent(parts[0])}/${encodeURIComponent(parts[1])}`;
        }
        window.location.href = path;
      }
      // Swap buttons for H2H and Prediction
      (function(){
        const s1 = document.getElementById('swapH2HBtn');
        if (s1) s1.addEventListener('click', () => {
          const a = document.getElementById('h2h-home');
          const b = document.getElementById('h2h-away');
          const t = a.value; a.value = b.value; b.value = t;
        });
        const s2 = document.getElementById('swapPredBtn');
        if (s2) s2.addEventListener('click', () => {
          const a = document.getElementById('pred-home');
          const b = document.getElementById('pred-away');
          const t = a.value; a.value = b.value; b.value = t;
        });
      })();
      function renderItems(items) {
        results.innerHTML = '';
        if (!items || items.length === 0) {
          results.innerHTML = '<div class="sub">No results.</div>';
          return;
        }
        for (const it of items) {
          const div = document.createElement('div');
          div.className = 'card slide-up';
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = it._entity || '-';
          const box = document.createElement('div');
          const title = document.createElement('div');
          title.className = 'title';
          title.innerHTML = highlight(it._title || it._id, q.value);
          const sub = document.createElement('div');
          sub.className = 'sub';
          sub.innerHTML = highlight(it._subtitle || '', q.value);
          const extra = document.createElement('div');
          extra.className = 'extra';
          extra.textContent = it._extra || '';
          box.appendChild(title);
          if (sub.textContent) box.appendChild(sub);
          if (extra.textContent) box.appendChild(extra);
          div.appendChild(badge);
          div.appendChild(box);
          div.style.cursor = 'pointer';
          div.addEventListener('click', () => openEntity(it));
          results.appendChild(div);
        }
      }

      async function doSearch(text) {
        home.style.display = 'none';
        err.textContent = '';
        setLoading(meta, true);
        results.innerHTML = Array.from({length: 5}).map(()=>'<div class="card"><div class="skeleton" style="width:76px;height:22px;border-radius:6px"></div><div style="flex:1"><div class="skeleton" style="height:14px;margin-bottom:8px"></div><div class="skeleton" style="height:12px;width:60%"></div></div></div>').join('');
        btn.disabled = true;
        try {
          const url = `/search?q=${encodeURIComponent(text)}&limit=50`;
          const res = await fetch(url, { headers: { 'accept': 'application/json' } });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          meta.textContent = `Query: ${data?.meta?.query || text} | Results: ${data?.total ?? data?.items?.length ?? 0}`;
          renderItems(data.items || []);
        } catch (e) {
          console.error(e);
          err.textContent = `Error: ${e.message || e}`;
          meta.textContent = '';
        } finally {
          btn.disabled = false;
          setLoading(meta, false);
        }
      }

      function renderSuggest(items) {
        if (!items || items.length === 0) { sugg.style.display = 'none'; sugg.innerHTML = ''; return; }
        sugg.innerHTML = '';
        items.slice(0, 12).forEach((it, idx) => {
          const div = document.createElement('div');
          div.className = 's-item' + (idx === 0 ? ' active' : '');
          div.dataset.idx = idx;
          const badge = document.createElement('div');
          badge.className = 's-entity'; badge.textContent = it._entity || '-';
          const box = document.createElement('div');
          const t = document.createElement('div'); t.className = 's-title'; t.innerHTML = highlight(it._title || it._id || '', q.value);
          const s = document.createElement('div'); s.className = 's-sub'; s.innerHTML = highlight(it._subtitle || '', q.value);
          box.appendChild(t); if (s.textContent) box.appendChild(s);
          div.appendChild(badge); div.appendChild(box);
          div.addEventListener('mousedown', (ev) => {
            ev.preventDefault();
            q.value = (it._title || it._id || '').toString();
            sugg.style.display='none';
            if (it && it._entity && it._id) {
              openEntity(it);
            } else {
              doSearch(q.value);
            }
          });
          sugg.appendChild(div);
        });
        sugg.style.display = 'block';
      }

      // Instant suggest with small debounce + matchup preference
      let suggestTimer = null;
      q.addEventListener('input', () => {
        const text = (q.value || '').trim();
        if (!text) {
          if (suggestTimer) clearTimeout(suggestTimer);
          sugg.style.display = 'none';
          sugg.innerHTML = '';
          lastGoodQuery = '';
          lastGoodItems = [];
          return;
        }
        const myReq = ++activeSuggestReq;
        const fetchAndRender = async () => {
          try {
            const looksMatchup = /\\\\s(?:vs\\\\.?|@|v)\\\\s/i.test(text);
            const url = looksMatchup ? `/suggest-matchup?q=${encodeURIComponent(text)}&limit=15` : `/suggest?q=${encodeURIComponent(text)}&limit=15`;
            const res = await fetch(url, { headers: { 'accept': 'application/json' } });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            if (myReq !== activeSuggestReq) return;
            const items = (data.items || []).slice(0, 12);
            if ((items.length === 0) && lastGoodItems.length) {
              renderSuggest(lastGoodItems);
            } else {
              renderSuggest(items);
              if (items.length) { lastGoodItems = items; lastGoodQuery = text; }
            }
          } catch {}
        };
        fetchAndRender();
        if (suggestTimer) clearTimeout(suggestTimer);
        suggestTimer = setTimeout(fetchAndRender, 120);
      });

      // keyboard navigation for suggestions
      function openPredictInline() {
        const h = (document.getElementById('pred-home').value || '').trim();
        const a = (document.getElementById('pred-away').value || '').trim();
        if (!h || !a) return; // require both
        location.href = `/predict-ui?home=${encodeURIComponent(h)}&away=${encodeURIComponent(a)}`;
      }
      // keyboard navigation for suggestions
      q.addEventListener('keydown', (ev) => {
        if (sugg.style.display === 'none') return;
        const items = Array.from(sugg.querySelectorAll('.s-item'));
        if (!items.length) return;
        const idx = items.findIndex(n => n.classList.contains('active'));
        if (ev.key === 'ArrowDown' || ev.key === 'ArrowUp') {
          ev.preventDefault();
          let ni = idx + (ev.key === 'ArrowDown' ? 1 : -1);
          if (ni < 0) ni = items.length-1; if (ni >= items.length) ni = 0;
          items.forEach(n => n.classList.remove('active')); items[ni].classList.add('active');
          items[ni].scrollIntoView({ block: 'nearest' });
        } else if (ev.key === 'Enter') {
          const active = items[idx >= 0 ? idx : 0];
          if (active) { active.dispatchEvent(new MouseEvent('mousedown')); }
        } else if (ev.key === 'Escape') {
          sugg.style.display = 'none';
        }
      });
      q.addEventListener('blur', () => { setTimeout(() => { sugg.style.display='none'; }, 150); });

      f.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const text = (q.value || '').trim();
        if (!text) return;
        doSearch(text);
      });

      // Direct navigation helpers
      async function navigatePlayerByName(name) {
        const text = (name || '').trim(); if (!text) return;
        try {
          const r = await fetch(`/suggest?q=${encodeURIComponent(text)}&entity=player&limit=3`, { headers: { 'accept': 'application/json' } });
          if (r.ok) { const d = await r.json(); const it = (d.items || []).find(x => (x && x._entity === 'player' && x._id)); if (it) { window.location.href = `/player/${encodeURIComponent(it._id)}`; return; } }
        } catch {}
        q.value = text; doSearch(text);
      }
      async function navigateTeamByName(name) {
        const text = (name || '').trim(); if (!text) return;
        try {
          const r = await fetch(`/suggest?q=${encodeURIComponent(text)}&entity=team&limit=3`, { headers: { 'accept': 'application/json' } });
          if (r.ok) { const d = await r.json(); const it = (d.items || []).find(x => (x && x._entity === 'team' && x._id)); if (it) { window.location.href = `/team/${encodeURIComponent(it._id)}`; return; } }
        } catch {}
        q.value = text; doSearch(text);
      }

      // H2H suggest helpers
      async function fetchTeamSuggest(text) {
        const res = await fetch(`/suggest?q=${encodeURIComponent(text)}&entity=team&limit=10`, { headers: { 'accept': 'application/json' } });
        if (!res.ok) return [];
        const data = await res.json();
        const raw = (data.items || []).filter(it => (it._entity||'') === 'team');
        const seen = new Set();
        return raw.filter(it => { const k = `${it._entity}:${it._id}`; if (seen.has(k)) return false; seen.add(k); return true; });
      }
      function renderTeamSuggest(container, input, items) {
        if (!items || items.length === 0) { container.style.display='none'; container.innerHTML=''; return; }
        container.innerHTML = '';
        items.slice(0, 10).forEach((it, idx) => {
          const div = document.createElement('div'); div.className = 's-item' + (idx === 0 ? ' active' : '');
          const badge = document.createElement('div'); badge.className='s-entity'; badge.textContent='team';
          const box = document.createElement('div');
          const t = document.createElement('div'); t.className='s-title'; t.textContent = it._title || '';
          const s = document.createElement('div'); s.className='s-sub'; s.textContent = it._subtitle || '';
          box.appendChild(t); if (s.textContent) box.appendChild(s);
          div.appendChild(badge); div.appendChild(box);
          div.addEventListener('mousedown', (ev) => { ev.preventDefault(); input.value = it._title || it._id || ''; container.style.display='none'; });
          container.appendChild(div);
        });
        container.style.display='block';
      }
      function wireTeamSuggest(input, container) {
        let timer = null;
        input.addEventListener('input', () => {
          const text = (input.value || '').trim();
          if (timer) clearTimeout(timer);
          if (!text) { container.style.display='none'; container.innerHTML=''; return; }
          timer = setTimeout(async () => { try { const items = await fetchTeamSuggest(text); renderTeamSuggest(container, input, items); } catch {} }, 140);
        });
        input.addEventListener('keydown', (ev) => {
          if (container.style.display === 'none') return;
          const items = Array.from(container.querySelectorAll('.s-item')); if (!items.length) return;
          const idx = items.findIndex(n => n.classList.contains('active'));
          if (ev.key === 'ArrowDown' || ev.key === 'ArrowUp') { ev.preventDefault(); let ni = idx + (ev.key === 'ArrowDown' ? 1 : -1); if (ni < 0) ni = items.length-1; if (ni >= items.length) ni = 0; items.forEach(n => n.classList.remove('active')); items[ni].classList.add('active'); items[ni].scrollIntoView({ block:'nearest' }); }
          else if (ev.key === 'Enter') { const active = items[idx >= 0 ? idx : 0]; if (active) active.dispatchEvent(new MouseEvent('mousedown')); }
          else if (ev.key === 'Escape') { container.style.display='none'; }
        });
        input.addEventListener('blur', () => setTimeout(() => container.style.display='none', 150));
      }
      async function resolveTeamId(name) {
        const t = (name || '').trim(); if (!t) return null;
        if (/^\d+$/.test(t)) return t;
        try { const items = await fetchTeamSuggest(t); return items && items[0] && items[0]._id ? items[0]._id : null; } catch { return null; }
      }
  async function openH2H() {
        const h = document.getElementById('h2h-home').value.trim();
        const a = document.getElementById('h2h-away').value.trim();
        if (!h || !a) return;
        const [hid, aid] = await Promise.all([resolveTeamId(h), resolveTeamId(a)]);
        if (hid && aid) { location.href = `/matchup/${encodeURIComponent(hid)}/${encodeURIComponent(aid)}`; }
        else { q.value = `${h} vs ${a}`; doSearch(q.value); }
  }

      // Load and render conference standings (full list)
      async function loadStandings() {
        try {
          const r = await fetch('/standings', { headers: { 'accept': 'application/json' } });
          if (!r.ok) return;
          const d = await r.json();
          const fill = (id, items) => {
            const box = document.getElementById(id);
            if (!box) return;
            Array.from(box.querySelectorAll('.team')).forEach(n => n.remove());
            (items || []).forEach(it => {
              const row = document.createElement('div'); row.className = 'team';
              const name = document.createElement('div'); name.className = 'col-name';
              const a = document.createElement('a'); a.href = '/?q=' + encodeURIComponent(it.name || it.city || it.id); a.textContent = it.name || it.city || it.id; a.addEventListener('click', (ev) => { ev.preventDefault(); navigateTeamByName(it.name || it.city || String(it.id)); });
              name.appendChild(a);
              const wl = document.createElement('div'); wl.className = 'col-wl'; wl.textContent = `${it.w ?? '-'}-${it.l ?? '-'}`;
              const gb = document.createElement('div'); gb.className = 'col-gb'; gb.textContent = (typeof it.gb === 'number') ? (Math.round(it.gb * 10) / 10).toFixed(1) : '-';
              const st = document.createElement('div'); st.className = 'col-streak'; st.textContent = it.streak || '-';
              row.appendChild(name); row.appendChild(wl); row.appendChild(gb); row.appendChild(st); box.appendChild(row);
            });
          };
          fill('std-east', d.east);
          fill('std-west', d.west);
        } catch {}
      }

      // chips wiring
      document.getElementById('chips-players').addEventListener('click', (e) => {
        const chip = e.target.closest('.chip'); if (!chip) return; navigatePlayerByName(chip.textContent.trim());
      });
      // quick-links teams
      document.querySelectorAll('#quick-links a[data-team]').forEach(a => {
        a.addEventListener('click', (ev) => { ev.preventDefault(); navigateTeamByName(a.getAttribute('data-team') || a.textContent || ''); });
      });
      // wire h2h suggest + actions
      wireTeamSuggest(document.getElementById('h2h-home'), document.getElementById('sugg-h2h-home'));
      wireTeamSuggest(document.getElementById('h2h-away'), document.getElementById('sugg-h2h-away'));
      document.getElementById('btnH2H').addEventListener('click', openH2H);
      // H2H swap/clear
      document.getElementById('pred-away').addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); openPredictInline(); }});
      document.getElementById('h2h-home').addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); openH2H(); }});
      document.getElementById('h2h-away').addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); openH2H(); }});

      // boot
      const u = new URL(location.href);
      const qp = (u.searchParams.get('q') || '').trim();
      if (qp) { q.value = qp; doSearch(qp); }
      else { home.style.display = 'grid'; q.focus(); loadStandings(); }
    </script>
  </body>
</html>









